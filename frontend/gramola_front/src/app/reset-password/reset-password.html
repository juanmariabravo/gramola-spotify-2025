<div class="container">
    <header class="header">
        <h1 class="logo">Gramola <span style="color: rgb(131, 131, 255); font-size: 1.3em;">e</span><span
                style="font-size: 1.3em;">s</span><span style="color: rgb(131, 131, 255); font-size: 1.3em;">i</span>potify</h1>
    </header>
    <div class="card">
        <h2>Restablecer Contraseña</h2>

        <!-- Validando token -->
        @if (isValidatingToken) {
            <div class="validating-section">
                <div class="spinner-feedback"></div>
                <p>Validando enlace de recuperación...</p>
            </div>
        }

        <!-- Token inválido o expirado -->
        @if (!isValidatingToken && !tokenValid) {
            <div class="error-section">
                <div class="error-icon">⚠️</div>
                <p class="error-text">{{feedbackMessage}}</p>
                <button type="button" (click)="goToRecover()" class="btn btn-primary">
                    Solicitar nuevo enlace
                </button>
                <div class="login-link">
                    <p><a (click)="goToLogin()" class="link">Volver al inicio de sesión</a></p>
                </div>
            </div>
        }

        <!-- Formulario para nueva contraseña (solo si token es válido) -->
        @if (!isValidatingToken && tokenValid) {
            <p class="reset-description">Introduce tu nueva contraseña para la cuenta: <strong>{{email}}</strong></p>
            
            <form class="form" [formGroup]="resetForm" (ngSubmit)="onSubmit()">
                <div class="form-group">
                    <label for="password">Nueva Contraseña</label>
                    <input type="password" id="password" formControlName="password" class="form-control" required>
                    @if (resetForm.controls['password'].invalid && (resetForm.controls['password'].dirty || resetForm.controls['password'].touched)) {
                        <div class="error-message">
                            @if (resetForm.controls['password'].errors?.['required']) {
                                <span>La contraseña es obligatoria.</span>
                            }
                            @if (resetForm.controls['password'].errors?.['minlength']) {
                                <span>La contraseña debe tener al menos 8 caracteres.</span>
                            }
                        </div>
                    }
                </div>

                <div class="form-group">
                    <label for="confirmPassword">Confirmar Nueva Contraseña</label>
                    <input type="password" id="confirmPassword" formControlName="confirmPassword" class="form-control" required>
                    @if (resetForm.controls['confirmPassword'].invalid && (resetForm.controls['confirmPassword'].dirty || resetForm.controls['confirmPassword'].touched)) {
                        <div class="error-message">
                            @if (resetForm.controls['confirmPassword'].errors?.['required']) {
                                <span>Debes confirmar la contraseña.</span>
                            }
                            @if (resetForm.controls['confirmPassword'].errors?.['minlength']) {
                                <span>La contraseña debe tener al menos 8 caracteres.</span>
                            }
                        </div>
                    }
                    @if (resetForm.controls['confirmPassword'].value && !passwordsMatch() && resetForm.controls['confirmPassword'].touched) {
                        <div class="error-message">
                            <span>Las contraseñas no coinciden.</span>
                        </div>
                    }
                </div>

                <!-- Feedback messages -->
                @if (isLoading) {
                    <div class="feedback-container loading">
                        <div class="spinner-feedback"></div>
                        <p>Restableciendo contraseña...</p>
                    </div>
                }

                @if (feedbackMessage && !isLoading) {
                    <div class="feedback-container" [class.success]="feedbackType === 'success'" [class.error]="feedbackType === 'error'">
                        <div class="feedback-icon">
                            @if (feedbackType === 'success') {
                                <span>✓</span>
                            }
                            @if (feedbackType === 'error') {
                                <span>⚠️</span>
                            }
                        </div>
                        <p>{{feedbackMessage}}</p>
                    </div>
                }

                <button type="submit" class="btn btn-primary" [disabled]="resetForm.invalid || !passwordsMatch() || isLoading">
                    @if (isLoading) {
                        <span>Restableciendo...</span>
                    } @else {
                        <span>Restablecer Contraseña</span>
                    }
                </button>

                <div class="login-link">
                    <p>¿Recordaste tu contraseña? <a (click)="goToLogin()" class="link">Iniciar sesión</a></p>
                </div>
            </form>
        }
    </div>
</div>
