<div class="setup-container">
  <div class="setup-card">
    <div class="setup-header">
      <h1 class="logo">Configuraci√≥n de <span class="esi-e">e</span><span class="esi-s">s</span><span
          class="esi-i">i</span><span class="spotify">potify</span></h1>
      <p class="subtitle">Selecciona el precio de cada canci√≥n, tu dispositivo de reproducci√≥n y la playlist que sonar√° por
        defecto</p>
    </div>
<!-- Mostrar firma del propietario -->
@if (userSignature) {
<div class="signature-welcome">
  <p class="signature-welcome-text">Bienvenido de nuevo, {{barName}}</p>
  <div class="signature-display-card">
    <img [src]="userSignature" alt="Firma del propietario" class="signature-img-display" />
  </div>
</div>
}

    @if (loading) {
    <div class="loading-overlay">
      <div class="spinner-large"></div>
      <p>Cargando dispositivos y playlists...</p>
    </div>
    }

        <!-- Configuraci√≥n de precio por canci√≥n -->
        <section class="section" *ngIf="!loading">
            <h3 class="section-title">1. Precio por canci√≥n</h3>
            <p class="section-subtitle">Define cu√°nto cobrar√°s a los usuarios por a√±adir una canci√≥n a la cola</p>
        
            <div class="price-config-container">
                <div class="price-slider-container">
                    <input type="range" id="songPrice" [(ngModel)]="songPrice" [min]="minPrice" [max]="maxPrice" step="5"
                        class="price-slider" aria-label="Precio por canci√≥n en c√©ntimos" />
                </div>
        
                <div class="price-display">
                    <span class="price-value">{{getFormattedSongPrice()}}‚Ç¨</span>
                    <span class="price-label">por canci√≥n</span>
                </div>
        
                <div class="price-range-labels">
                    <span class="range-min">{{minPrice / 100 | number:'1.2-2'}}‚Ç¨</span>
                    <span class="range-max">{{maxPrice / 100 | number:'1.2-2'}}‚Ç¨</span>
                </div>
            </div>
        </section>

    <!-- Selecci√≥n de dispositivo -->
    @if (!loading) {
    <section class="section">
      <h3 class="section-title">2. Dispositivo de reproducci√≥n</h3>
      <p class="section-subtitle">Elige d√≥nde quieres reproducir la m√∫sica</p>

      <div class="devices-list">
        @for (device of devices; track device.id) {
        <div
              class="device-item"
              [class.selected]="device.id === selectedDeviceId"
              (click)="selectDevice(device.id)"
              role="button"
              tabindex="0"
              (keydown.enter)="selectDevice(device.id)">
          <span class="device-icon">{{getDeviceIcon(device.type)}}</span>
          <div class="device-details">
            <h4 class="device-name">{{device.name}}</h4>
            <p class="device-type">{{device.type}}</p>
          </div>
          <span *ngIf="device.id === selectedDeviceId" class="device-badge">‚úì Activo</span>
          </div>
          }
      </div>

      <div *ngIf="deviceError" class="error-message">
        <span class="error-icon">‚ö†Ô∏è</span>
        {{deviceError}}
      </div>

      <div *ngIf="devices.length === 0 && !deviceError" class="empty-message">
        <span class="empty-icon">üì±</span>
        <p>No se encontraron dispositivos disponibles.</p>
        <p class="hint">Aseg√∫rate de tener Spotify abierto en alg√∫n dispositivo.</p>
      </div>
    </section>
    }


    <div class="actions" *ngIf="!loading">
      <button class="confirm-btn" (click)="confirmSelection()" [disabled]="!selectedDeviceId">
        Continuar a la Gramola
      </button>
      <p class="action-hint">Puedes continuar sin seleccionar playlist. Se reanudar√° la √∫ltima reproducci√≥n.</p>
    </div>



    <!-- Selecci√≥n de playlist -->
    <section class="section" *ngIf="!loading">
      <h3 class="section-title">3. Playlist por defecto (opcional)</h3>
      <p class="section-subtitle">Selecciona una playlist para reproducir por defecto o contin√∫a sin ella</p>

      <!-- Barra de b√∫squeda de playlists -->
      <div class="search-container">
        <input type="text"
               [(ngModel)]="playlistSearchQuery"
               (ngModelChange)="onSearchChange($event)"
               placeholder="Buscar playlist..."
               class="search-input"
               aria-label="Buscar playlists" />
        <span class="search-icon">üîç</span>
      </div>

      <!-- Toggle para mostrar todas las playlists -->
      <div class="playlist-view-toggle" *ngIf="filteredPlaylists().length > 6">
        <button class="toggle-btn" (click)="showAllPlaylists = !showAllPlaylists">
          {{ showAllPlaylists ? '‚ñ≤ Mostrar menos' : '‚ñº Ver todas las playlists (' + filteredPlaylists().length + ')' }}
        </button>
      </div>

      <div class="playlists-grid">
        <div *ngFor="let playlist of getVisiblePlaylists()"
             class="playlist-card"
             [class.selected]="playlist.id === selectedPlaylistId"
             (click)="selectPlaylist(playlist.id)"
             role="button"
             tabindex="0"
             (keydown.enter)="selectPlaylist(playlist.id)">
          <div class="playlist-cover">
            <img *ngIf="playlist.images && playlist.images.length > 0"
                 [src]="playlist.images[0]?.url"
                 [alt]="playlist.name"
                 class="playlist-img" />
            <div *ngIf="!playlist.images || playlist.images.length === 0" class="playlist-placeholder">
              üéµ
            </div>
          </div>
          <h4 class="playlist-card-name">{{playlist.name}}</h4>
          <span *ngIf="playlist.id === selectedPlaylistId" class="selected-badge-small">‚úì</span>
        </div>
      </div>

      <div *ngIf="playlistError" class="error-message">
        <span class="error-icon">‚ö†Ô∏è</span>
        {{playlistError}}
      </div>

      <div *ngIf="filteredPlaylists().length === 0 && !playlistError" class="empty-message">
        <span class="empty-icon">üé∂</span>
        <p *ngIf="!playlistSearchQuery">No se encontraron playlists en tu cuenta.</p>
        <p *ngIf="playlistSearchQuery">No se encontraron playlists (propias ni p√∫blicas) que coincidan con "{{playlistSearchQuery}}".</p>
      </div>
    </section>
  </div>
</div>
