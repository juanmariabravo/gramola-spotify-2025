<div class="setup-container">
  <div class="setup-card">
    <div class="setup-header">
      <div class="logo">Configuraci√≥n de ESIpotify</div>
      <p class="subtitle">Selecciona tu dispositivo de reproducci√≥n y playlist por defecto</p>
    </div>

    @if (loading) {
    <div class="loading-overlay">
      <div class="spinner-large"></div>
      <p>Cargando dispositivos y playlists...</p>
    </div>
    }

    <!-- Selecci√≥n de dispositivo -->
    @if (!loading) {
    <section class="section">
      <h3 class="section-title">1. Dispositivo de reproducci√≥n</h3>
      <p class="section-subtitle">Elige d√≥nde quieres reproducir la m√∫sica</p>

      @for (device of devices; track device.id) {
      <div
            class="device-card"
            [class.selected]="device.id === selectedDeviceId"
            (click)="selectDevice(device.id)"
            role="button"
            tabindex="0"
            (keydown.enter)="selectDevice(device.id)">
        <span class="device-icon-large">{{getDeviceIcon(device.type)}}</span>
        <h4 class="device-card-name">{{device.name}}</h4>
        <p class="device-card-type">{{device.type}}</p>
        <span *ngIf="device.id === selectedDeviceId" class="selected-badge">‚úì Seleccionado</span>
      </div>
      }
      

      <div *ngIf="deviceError" class="error-message">
        <span class="error-icon">‚ö†Ô∏è</span>
        {{deviceError}}
      </div>

      <div *ngIf="devices.length === 0 && !deviceError" class="empty-message">
        <span class="empty-icon">üì±</span>
        <p>No se encontraron dispositivos disponibles.</p>
        <p class="hint">Aseg√∫rate de tener Spotify abierto en alg√∫n dispositivo.</p>
      </div>
    </section>
    }

    <!-- Selecci√≥n de playlist -->
    <section class="section" *ngIf="!loading">
      <h3 class="section-title">2. Playlist por defecto (opcional)</h3>
      <p class="section-subtitle">Selecciona una playlist para reproducir por defecto</p>

      <!-- Barra de b√∫squeda de playlists -->
      <div class="search-container">
        <input type="text"
               [(ngModel)]="playlistSearchQuery"
               (ngModelChange)="onSearchChange($event)"
               placeholder="Buscar playlist..."
               class="search-input"
               aria-label="Buscar playlists" />
        <span class="search-icon">üîç</span>
      </div>

      <div class="playlists-grid">
        <div *ngFor="let playlist of filteredPlaylists()"
             class="playlist-card"
             [class.selected]="playlist.id === selectedPlaylistId"
             (click)="selectPlaylist(playlist.id)"
             role="button"
             tabindex="0"
             (keydown.enter)="selectPlaylist(playlist.id)">
          <div class="playlist-cover">
            <img *ngIf="playlist.images && playlist.images.length > 0"
                 [src]="playlist.images[0]?.url"
                 [alt]="playlist.name"
                 class="playlist-img" />
            <div *ngIf="!playlist.images || playlist.images.length === 0" class="playlist-placeholder">
              üéµ
            </div>
          </div>
          <h4 class="playlist-card-name">{{playlist.name}}</h4>
          <span *ngIf="playlist.id === selectedPlaylistId" class="selected-badge-small">‚úì</span>
        </div>
      </div>

      <div *ngIf="playlistError" class="error-message">
        <span class="error-icon">‚ö†Ô∏è</span>
        {{playlistError}}
      </div>

      <div *ngIf="filteredPlaylists().length === 0 && !playlistError" class="empty-message">
        <span class="empty-icon">üé∂</span>
        <p *ngIf="!playlistSearchQuery">No se encontraron playlists en tu cuenta.</p>
        <p *ngIf="playlistSearchQuery">No se encontraron playlists (propias ni p√∫blicas) que coincidan con "{{playlistSearchQuery}}".</p>
      </div>
    </section>

    <!-- Bot√≥n de confirmaci√≥n -->
    <div class="actions" *ngIf="!loading">
      <button class="confirm-btn" (click)="confirmSelection()" [disabled]="!selectedDeviceId">
        Continuar a la Gramola
      </button>
    </div>
  </div>
</div>
