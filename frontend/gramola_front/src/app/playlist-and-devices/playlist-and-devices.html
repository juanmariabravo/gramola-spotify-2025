<app-navbar></app-navbar>

<div class="setup-container">
  <div class="setup-card">
    <div class="setup-header">
      <h1 class="logo">Configuración de <span class="esi-e">e</span><span class="esi-s">s</span><span
          class="esi-i">i</span><span class="spotify">potify</span></h1>
      <p class="subtitle">Selecciona el precio de cada canción, tu dispositivo de reproducción y la playlist que sonará por
        defecto</p>
    </div>
<!-- Mostrar firma del propietario -->
@if (userSignature) {
<div class="signature-welcome">
  <p class="signature-welcome-text">Bienvenido de nuevo, {{barName}}</p>
  <div class="signature-display-card">
    <img [src]="userSignature" alt="Firma del propietario" class="signature-img-display" />
  </div>
</div>
}

    @if (loading) {
    <div class="loading-overlay">
      <div class="spinner-large"></div>
      <p>Cargando dispositivos y playlists...</p>
    </div>
    }

        <!-- Configuración de precio por canción -->
        <section class="section" *ngIf="!loading">
            <h3 class="section-title">1. Precio por canción</h3>
            <p class="section-subtitle">Define cuánto cobrarás a los usuarios por añadir una canción a la cola (también puedes
              ofrecerlo gratis)</p>
        
            <div class="price-config-container">
                <div class="price-slider-container">
                    <input type="range" id="songPrice" [(ngModel)]="songPrice" (ngModelChange)="onPriceChange()" [min]="minPrice"
                      [max]="maxPrice" step="10"
                        class="price-slider" aria-label="Precio por canción en céntimos" />
                </div>
        
                <div class="price-display">
                    <span class="price-value">{{ songPrice === 0 ? 'GRATIS' : getFormattedSongPrice() + '€' }}</span>
                    <span class="price-label">{{ songPrice === 0 ? 'Sin coste para los usuarios' : 'por canción' }}</span>
                </div>
        
                <div class="price-range-labels">
                    <span class="range-min">Gratis</span>
                    <span class="range-max">{{maxPrice / 100 | number:'1.2-2'}}€</span>
                </div>
            </div>
        </section>

    <!-- Selección de dispositivo -->
    @if (!loading) {
    <section class="section">
      <h3 class="section-title">2. Dispositivo de reproducción</h3>
      <p class="section-subtitle">Elige dónde quieres reproducir la música</p>

      <div class="devices-list">
        @for (device of devices; track device.id) {
        <div
              class="device-item"
              [class.selected]="device.id === selectedDeviceId"
              (click)="selectDevice(device.id)"
              role="button"
              tabindex="0"
              (keydown.enter)="selectDevice(device.id)">
          <span class="device-icon material-icons">{{device.type.toLowerCase()}}</span>
          <div class="device-details">
            <h4 class="device-name">{{device.name}}</h4>
            <p class="device-type">{{device.type}}</p>
          </div>
          <span *ngIf="device.id === selectedDeviceId" class="device-badge"><span class="material-icons">check_circle</span>
            Activo</span>
          </div>
          }
      </div>

      <div *ngIf="deviceError" class="error-message">
        <span class="error-icon material-icons">warning</span>
        {{deviceError}}
      </div>

      <div *ngIf="devices.length === 0 && !deviceError" class="empty-message">
        <span class="empty-icon material-icons">devices</span>
        <p>No se encontraron dispositivos disponibles.</p>
        <p class="hint">Asegúrate de tener Spotify abierto en algún dispositivo.</p>
      </div>
    </section>
    }


    <div class="actions" *ngIf="!loading">
      <button class="confirm-btn" (click)="confirmSelection()" [disabled]="!selectedDeviceId">
        Continuar a la Gramola
      </button>
      <p class="action-hint">Puedes continuar sin seleccionar playlist. Se reanudará la última reproducción.</p>
    </div>



    <!-- Selección de playlist -->
    <section class="section" *ngIf="!loading">
      <h3 class="section-title">3. Playlist por defecto (opcional)</h3>
      <p class="section-subtitle">Selecciona una playlist para reproducir por defecto o continúa sin ella</p>

      <!-- Barra de búsqueda de playlists -->
      <div class="search-container">
        <input type="text"
               [(ngModel)]="playlistSearchQuery"
               (ngModelChange)="onSearchChange($event)"
               placeholder="Buscar playlist..."
               class="search-input"
               aria-label="Buscar playlists" />
        <span class="search-icon material-icons">search</span>
      </div>

      <!-- Toggle para mostrar todas las playlists -->
      <div class="playlist-view-toggle" *ngIf="filteredPlaylists().length > 6">
        <button class="toggle-btn" (click)="showAllPlaylists = !showAllPlaylists">
          {{ showAllPlaylists ? 'Mostrar menos' : 'Ver todas las playlists (' + filteredPlaylists().length + ')' }}
          <span class="material-icons">{{ showAllPlaylists ? 'expand_less' : 'expand_more' }}</span>
        </button>
      </div>

      <div class="playlists-grid">
        <div *ngFor="let playlist of getVisiblePlaylists()"
             class="playlist-card"
             [class.selected]="playlist.id === selectedPlaylistId"
             (click)="selectPlaylist(playlist.id!)"
             role="button"
             tabindex="0"
             (keydown.enter)="selectPlaylist(playlist.id!)">
          <div class="playlist-cover">
            <img *ngIf="playlist.images && playlist.images.length > 0"
                 [src]="playlist.images[0]?.url"
                 [alt]="playlist.name"
                 class="playlist-img" />
            <div *ngIf="!playlist.images || playlist.images.length === 0" class="playlist-placeholder">
              <span class="material-icons">music_note</span>
            </div>
          </div>
          <h4 class="playlist-card-name">{{playlist.name}}</h4>
          <span *ngIf="playlist.id === selectedPlaylistId" class="selected-badge-small"><span
              class="material-icons">check_circle</span></span>
        </div>
      </div>

      <div *ngIf="playlistError" class="error-message">
        <span class="error-icon material-icons">warning</span>
        {{playlistError}}
      </div>

      <div *ngIf="filteredPlaylists().length === 0 && !playlistError" class="empty-message">
        <span class="empty-icon material-icons">library_music</span>
        <p *ngIf="!playlistSearchQuery">No se encontraron playlists en tu cuenta.</p>
        <p *ngIf="playlistSearchQuery">No se encontraron playlists (propias ni públicas) que coincidan con "{{playlistSearchQuery}}".</p>
      </div>
    </section>
  </div>
</div>
